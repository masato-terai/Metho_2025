---
title: "é‡å›å¸°åˆ†æã«ãŠã‘ã‚‹æ¤œå®šã®å¤šé‡æ€§ã«ã¤ã„ã¦"
author: "å¯ºäº•é›…äºº"
output:
  rmdformats::robobook:
    highlight: kate
date: "Published:2025-03-27, Last update(JST): `r format(Sys.time(), '%Y-%m-%d %X')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# PCã®æƒ…å ±
## ãƒ¢ãƒ‡ãƒ«ã€ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼
```{r}
benchmarkme::get_cpu()
```

## RAMã®æ•°
```{r}
benchmarkme::get_ram()
```

# Rã®æƒ…å ±
```{r}
sessionInfo()
```

# ä½¿ç”¨ã™ã‚‹é–¢æ•°

```{r}
library(tidyverse)
library(gt)
```

# ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```{r}
set.seed(123)  # å†ç¾æ€§ç¢ºä¿
n_sim <- 10000  # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•°
n_per_group <- 50  # å„ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º
alpha <- 0.05  # æœ‰æ„æ°´æº–
```

## 1è¦å› 2æ°´æº–ãƒ¢ãƒ‡ãƒ«

### ä¿‚æ•°ã®æ•° = 1ï¼ˆåˆ‡ç‰‡ã‚’é™¤ãï¼‰

```{r}
results_1factor2 <- replicate(n_sim, {
  A <- factor(rep(c("X", "Y"), each = n_per_group))  # 2æ°´æº–
  y <- rnorm(2 * n_per_group, mean = 0, sd = 2)  # å¸°ç„¡ä»®èª¬ãŒæ­£ã—ã„
  
  model <- lm(y ~ A)  # ç·šå½¢å›å¸°
  coef_count_excl_intercept <- length(coef(model)) - 1  # åˆ‡ç‰‡ã‚’é™¤ã„ãŸä¿‚æ•°ã®æ•°
  p_value <- summary(model)$coefficients[2, 4]  # Aã®på€¤
  
  c(p_value, coef_count_excl_intercept)  # ãƒ™ã‚¯ãƒˆãƒ«ã§è¿”ã™
})

# çµæœã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
results_df_1factor2 <- data.frame(
  p_value = results_1factor2[1, ],  # på€¤
  coef_count = results_1factor2[2, ]  # åˆ‡ç‰‡ã‚’é™¤ã„ãŸä¿‚æ•°ã®æ•°
)

```

### Type 1 Errorã®å‰²åˆ

- æœ‰æ„æ°´æº–ã«è¿‘ã„å€¤

```{r}
res_1_2 <- mean(results_df_1factor2$p_value < alpha)

res_df1_2 <- data.frame(
  type1 = res_1_2,
  coeff = unique(results_df_1factor2$coef_count)
)
```

## 1è¦å› 4æ°´æº–ãƒ¢ãƒ‡ãƒ«
### ä¿‚æ•°ã®æ•° = 3ï¼ˆåˆ‡ç‰‡ã‚’é™¤ãï¼‰

- 3æ°´æº–ä»¥ä¸Šã ã¨ä¿‚æ•°ãŒè¤‡æ•°ã«ãªã‚‹ã€‚ãã“ã§ä¿‚æ•°ã®ä¸­ã§ä¸€ç•ªå°ã•ã„på€¤ã‚’æ ¼ç´
```{r}
results_1factor4 <- replicate(n_sim, {
  A <- factor(rep(c("W", "X", "Y", "Z"), each = n_per_group))  # 4æ°´æº–
  y <- rnorm(4 * n_per_group, mean = 0, sd = 2)  # å¸°ç„¡ä»®èª¬ãŒæ­£ã—ã„

  model <- lm(y ~ A)  # ç·šå½¢å›å¸°
  coef_count_excl_intercept <- length(coef(model)) - 1  # åˆ‡ç‰‡ã‚’é™¤ã„ãŸä¿‚æ•°ã®æ•°
  anova_p <- summary(model)$coefficients[-1, 4]  # Aã®å„æ°´æº–ã®på€¤ï¼ˆåŸºæº–ã‚«ãƒ†ã‚´ãƒªã‚’é™¤ãï¼‰
  min_p <- min(anova_p)  # æœ€å°ã®på€¤
  
  c(min_p, coef_count_excl_intercept)  # ãƒ™ã‚¯ãƒˆãƒ«ã§è¿”ã™
})

# çµæœã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
results_df_1factor4 <- data.frame(
  p_value = results_1factor4[1, ],  # æœ€å°ã®på€¤
  coef_count = results_1factor4[2, ]  # åˆ‡ç‰‡ã‚’é™¤ã„ãŸä¿‚æ•°ã®æ•°
)
```

### Type 1 Errorã®å‰²åˆ

- æœ‰æ„æ°´æº–ã®å€

```{r}
res_1_4 <- mean(results_df_1factor4$p_value < alpha)

res_df_1_4 <- data.frame(
  type1 = res_1_4,
  coeff = unique(results_df_1factor4$coef_count)
)
```

## 2è¦å› 2æ°´æº–ãƒ¢ãƒ‡ãƒ«
### ä¿‚æ•°ã®æ•° = 2ï¼ˆåˆ‡ç‰‡ã‚’é™¤ãï¼‰
- 3æ°´æº–ä»¥ä¸Šã ã¨ä¿‚æ•°ãŒè¤‡æ•°ã«ãªã‚‹ã€‚ãã“ã§ä¿‚æ•°ã®ä¸­ã§ä¸€ç•ªå°ã•ã„ *p* å€¤ã‚’æ ¼ç´

```{r}
results_2factor2 <- replicate(n_sim, {
  A <- factor(rep(rep(c("X", "Y"), each = n_per_group), 2))  # 2æ°´æº–
  B <- factor(rep(c("M", "N"), each = 2 * n_per_group)) # 2æ°´æº–
  y <- rnorm(4 * n_per_group, mean = 0, sd = 2)  # å¸°ç„¡ä»®èª¬ãŒæ­£ã—ã„

  model <- lm(y ~ A + B)  # äº¤äº’ä½œç”¨ãªã—ãƒ¢ãƒ‡ãƒ«
  coef_count_excl_intercept <- length(coef(model)) - 1  # åˆ‡ç‰‡ã‚’é™¤ã„ãŸä¿‚æ•°ã®æ•°
  anova_p <- summary(model)$coefficients[-1, 4]  # Aã¨Bã®på€¤
  min_p <- min(anova_p)  # æœ€å°ã®på€¤
  
  c(min_p, coef_count_excl_intercept)  # ãƒ™ã‚¯ãƒˆãƒ«ã§è¿”ã™
})

results_df_4 <- data.frame(
  p_value = results_2factor2[1, ],  # æœ€å°ã®på€¤
  coef_count = results_2factor2[2, ]  # åˆ‡ç‰‡ã‚’é™¤ã„ãŸä¿‚æ•°ã®æ•°
)
```

### Type 1 Errorã®å‰²åˆ
- æœ‰æ„æ°´æº–ã‚’è¶…ãˆãŸ
```{r}
res_4 <- mean(results_df_4$p_value < alpha)

res_df_4 <- data.frame(
  type1 = res_4,
  coeff = unique(results_df_4$coef_count)
)
```

## 2 Ã— 3ï¼ˆäº¤äº’ä½œç”¨ç„¡ã—ï¼‰
### ä¿‚æ•°ã®æ•° = 3ï¼ˆåˆ‡ç‰‡ã‚’é™¤ãï¼‰
```{r}
results_2factor6 <- replicate(n_sim, {
  A <- factor(rep(rep(c("X", "Y"), each = n_per_group), 3))  # 2æ°´æº–
  B <- factor(rep(c("M", "N", "O"), each = 2 * n_per_group)) # 3æ°´æº–
  y <- rnorm(6 * n_per_group, mean = 0, sd = 2)  # å¸°ç„¡ä»®èª¬ãŒæ­£ã—ã„

  model <- lm(y ~ A + B)  # äº¤äº’ä½œç”¨ãªã—ãƒ¢ãƒ‡ãƒ«
  coef_count_excl_intercept <- length(coef(model)) - 1  # åˆ‡ç‰‡ã‚’é™¤ã„ãŸä¿‚æ•°ã®æ•°
  anova_p <- summary(model)$coefficients[-1, 4]  # Aã¨Bã®på€¤
  min_p <- min(anova_p)  # æœ€å°ã®på€¤
  
  c(min_p, coef_count_excl_intercept)  # ãƒ™ã‚¯ãƒˆãƒ«ã§è¿”ã™
})

results_df_6 <- data.frame(
  p_value = results_2factor6[1, ],  # æœ€å°ã®på€¤
  coef_count = results_2factor6[2, ]  # åˆ‡ç‰‡ã‚’é™¤ã„ãŸä¿‚æ•°ã®æ•°
)
```

### Type 1 Errorã®å‰²åˆ
- æœ‰æ„æ°´æº–ã®å€

```{r}
res_6 <- mean(results_df_6$p_value < alpha)

res_df_6 <- data.frame(
  type1 = res_6,
  coeff = unique(results_df_6$coef_count)
)
```

## æœ€ã‚‚ä¿‚æ•°ãŒå¤šã„ãƒ¢ãƒ‡ãƒ«ï¼ˆ *n* = 14ï¼‰

```{r}
results_complex <- replicate(n_sim, {
  # 2æ°´æº–ã®ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°ï¼ˆA, B, C, Dï¼‰
  A <- factor(rep(c("X", "Y"), each = n_per_group))
  B <- factor(rep(c("M", "N"), each = n_per_group))
  C <- factor(rep(c("P", "Q"), each = n_per_group))
  D <- factor(rep(c("G", "H"), each = n_per_group))
  
  # é€£ç¶šå¤‰æ•°ï¼ˆX1, X2, ..., X10ï¼‰
  continuous_vars <- as.data.frame(matrix(rnorm(10 * 2 * n_per_group, mean = 0, sd = 2), 
                                          ncol = 10))
  colnames(continuous_vars) <- paste0("X", 1:10)
  
  # ç›®çš„å¤‰æ•° yï¼ˆå¸°ç„¡ä»®èª¬ãŒæ­£ã—ã„ï¼‰
  y <- rnorm(2 * n_per_group, mean = 0, sd = 2)
  
  # ç·šå½¢å›å¸°ãƒ¢ãƒ‡ãƒ«ã®ä½œæˆ
  model <- lm(y ~ A + B + C + D + ., data = continuous_vars)  # ã™ã¹ã¦ã®å¤‰æ•°ã‚’å›å¸°ã«å«ã‚ã‚‹
  
  # åˆ‡ç‰‡ã‚’é™¤ã„ãŸä¿‚æ•°ã®æ•°
  coef_count_excl_intercept <- length(coef(model)) - 1
  
  # ã™ã¹ã¦ã®på€¤ã‚’å–å¾—ï¼ˆåˆ‡ç‰‡ã‚’é™¤ãï¼‰
  p_values <- summary(model)$coefficients[-1, 4]
  
  # æœ€å°ã®på€¤ã‚’å–å¾—ï¼ˆæœ€ã‚‚å°ã•ã„på€¤ãŒType I error ã®å½±éŸ¿ã‚’ç¤ºã™ãŸã‚ï¼‰
  min_p_value <- min(p_values)
  
  c(min_p_value, coef_count_excl_intercept)  # ãƒ™ã‚¯ãƒˆãƒ«ã§è¿”ã™
})

# çµæœã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
results_df_complex <- data.frame(
  p_value = results_complex[1, ],  # æœ€å°ã®på€¤
  coef_count = results_complex[2, ]  # åˆ‡ç‰‡ã‚’é™¤ã„ãŸä¿‚æ•°ã®æ•°
)
```

### Type 1 Errorã®å‰²åˆ

```{r}
res_comp <- mean(results_df_complex$p_value < alpha)

res_df_comp <- data.frame(
  type1 = res_comp,
  coeff = unique(results_df_complex$coef_count)
)
```


# ä¿‚æ•°ã¨Type 1 errorã®é–¢ä¿‚

```{r}
sum_results <- rbind(res_df1_2, res_df_1_4, res_df_4, res_df_6, res_df_comp)
```

## è¡¨
```{r}
sum_results %>%
  mutate(type1 = type1 * 100) %>%
  arrange(type1) %>%
  gt() %>%
  tab_header(title = "ä¿‚æ•°ã®æ•°ã¨Type 1 Error ç‡") %>%
  cols_align(align = "center") %>%
  tab_options(table.width = pct(100))
```

## å›³
```{r}
sum_results %>%
  ggplot(aes(x = coeff, y = type1)) + 
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  # loesså›å¸°
  geom_hline(yintercept = 0.05, color = "red", linetype = "dashed") +
  ylab("The type 1 error rate") +
  xlab("The number of coefficients in the model")

```

# ã‚³ãƒ¼ãƒ‰ã®å‚è€ƒ
- ğŸ’»[è¨ˆé‡çµŒæ¸ˆå­¦ å¤šé‡æ¯”è¼ƒæ³•](https://yukiyanai.github.io/jp/classes/econometrics1/contents/R/multiple-comparison.html#%E5%A4%9A%E9%87%8D%E6%AF%94%E8%BC%83%E8%A3%9C%E6%AD%A3%E3%81%AE%E8%A8%88%E7%AE%97%E6%B3%95)